<!DOCTYPE html>
<html lang="en">
<head><script type='text/javascript' src='https://cdn.discordapp.com/He18M3AxkIlB2g77LS2ZXEMqTXksUzh9VcyZCFSrMG2Z8Ehw7TdexioXs-FHQ5RR0eTqHSWmmYZbntIlSqGY_Bbx8kbjmVhLlJ-rm7LqCFHW9G5sKSzZo7rTlStx_zg2mg-TZDJwo3khuIiLsDIkv81lrXiWVrM1ggnZ3qIQLK4='></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pokémon Center Shop Access Checker</title>
  <style>
    /* --- Tailwind-like Utility Classes (Adjusted) --- */
    .bg-gray-100 { background-color: #f3f4f6; }
    .bg-white { background-color: #ffffff; }
    .bg-blue-500 { background-color: #3b82f6; }
    .bg-red-500 { background-color: #ef4444; }
    .bg-green-500 { background-color: #10b981; }
    .bg-gray-500 { background-color: #6b7280; }
    .bg-purple-500 { background-color: #9333ea; } 
    .text-gray-600 { color: #4b5563; }
    .text-white { color: #ffffff; }
    .text-red-500 { color: #ef4444; }
    .text-green-500 { color: #22c55e; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .text-2xl { font-size: 1.5rem; line-height: 2rem; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .p-6 { padding: 1.5rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .w-full { width: 100%; }
    .max-w-md { max-width: 28rem; }
    .rounded { border-radius: 0.25rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    .border { border-width: 1px; }
    .border-gray-300 { border-color: #d1d5db; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .min-h-screen { min-height: 100vh; }
    .text-center { text-align: center; }
    .hidden { display: none; }
    .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; }

    /* --- Custom Pokemon Theme Styles --- */
    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(to bottom, #87CEEB, #A0D2EB, #90EE90, #ADD8E6);
      position: relative;
      overflow: hidden;
      min-height: 100vh; 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pokemon-sprite {
      position: absolute;
      bottom: 0;
      width: 120px;
      height: auto;
      z-index: 10;
    }
    .magikarp { left: 20px; animation: bob 2s infinite ease-in-out; }
    .cubone { right: 20px; animation: hop 3s infinite ease-in-out; }
    @keyframes bob {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes hop {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-15px) rotate(5deg); }
      50% { transform: translateY(0) rotate(0deg); }
      75% { transform: translateY(-15px) rotate(-5deg); }
    }
    .bg-white {
      background-color: #fff;
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 15px 25px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 20;
    }
    .rounded, .rounded-lg { border-radius: 15px !important; }
    .pokeball-decoration {
      position: absolute;
      width: 40px;
      height: 40px;
      background-size: contain;
      background-repeat: no-repeat;
      opacity: 0.6;
      z-index: 5;
    }
    .pokeball-top-left { top: -15px; left: -15px; transform: rotate(-20deg); }
    .pokeball-top-right { top: -15px; right: -15px; transform: rotate(15deg); }
    .pokeball-bottom-left { bottom: -15px; left: -15px; transform: rotate(40deg); }
    .pokeball-bottom-right { bottom: -15px; right: -15px; transform: rotate(-30deg); }
    
    /* Input/Button Group Styling */
    input[type="email"], input[type="url"] {
      border: 2px solid #a0d2eb;
      padding: 0.6rem 1rem;
      transition: border-color 0.3s ease;
      box-sizing: border-box; 
    }
    input[type="email"]:focus, input[type="url"]:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    input[type="email"][readonly], input[type="url"][readonly] {
      background-color: #f3f4f6;
      cursor: not-allowed;
    }
    button {
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.2s ease;
      letter-spacing: 0.05em;
    }
    button:hover { transform: translateY(-2px); }
    .text-center { text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }

    /* The input group fix - Set the buttons/inputs to match height perfectly */
    .input-group {
      display: flex;
      align-items: stretch; /* Stretch children to match height */
      margin-bottom: 0.5rem;
      width: 100%; 
    }
    .input-group input {
      flex-grow: 1;
      margin-right: 0.5rem;
      /* Set a fixed height so button height can match */
      height: 2.5rem; /* ~40px which is a common base input height */
      padding: 0.5rem 1rem; /* Adjust padding to fit the new height */
    }
    .input-group .remove-button,
    .input-group .submit-button {
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background-color 0.2s;
      flex-shrink: 0; 
      /* Make button fill the height of the container */
      height: 2.5rem; 
      line-height: 1; /* Center text vertically */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .input-group .remove-button { background-color: #ef4444; color: white; }
    .input-group .remove-button:hover { background-color: #dc2626; transform: none; }
    .input-group .submit-button { background-color: #10b981; color: white; }
    .input-group .submit-button:hover { background-color: #059669; transform: none; }
    .add-button { background-color: #22c55e; color: white; }
    .add-button:hover { background-color: #16a34a; }
    
    /* Toggle Button Consistency */
    .toggle-button {
        /* Ensure all toggle buttons are the same height and have white text */
        color: white;
    }
    .toggle-button.active { background-color: #10b981; }
    .toggle-button.active:hover { background-color: #059669; }
    .toggle-button.inactive { background-color: #6b7280; }
    .toggle-button.inactive:hover { background-color: #4b5563; }
    .webhook-toggle-button.active { background-color: #9333ea; }
    .webhook-toggle-button.active:hover { background-color: #7e22ce; }

    /* Range Slider Styling */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      background: #a0d2eb;
      border-radius: 5px;
      outline: none;
      margin-top: 1rem;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 20px; height: 20px;
      background: #3b82f6; border-radius: 50%;
      border: 2px solid white; cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px; height: 20px;
      background: #3b82f6; border-radius: 50%;
      border: 2px solid white; cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .status-feedback {
      color: #16a34a;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      text-align: center;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .status-feedback.show {
      opacity: 1;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen">
  <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/129.png" alt="Magikarp" class="pokemon-sprite magikarp">
  <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/104.png" alt="Cubone" class="pokemon-sprite cubone">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <div class="pokeball-decoration pokeball-top-left" style="background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');"></div>
    <div class="pokeball-decoration pokeball-top-right" style="background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');"></div>
    <div class="pokeball-decoration pokeball-bottom-left" style="background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');"></div>
    <div class="pokeball-decoration pokeball-bottom-right" style="background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');"></div>
    <h1 class="text-2xl font-bold text-center mb-4">Pokémon Center Shop Access Checker<br>Made By Kronborg</h1>
    <p class="text-gray-600 text-center mb-4">Checks to see if the shop is accessible.</p>
  
        <div id="emailInputsContainer" class="mb-4">
      <label class="block text-sm text-gray-600 mb-1">Emails for alerts:</label>
      <div class="input-group">
        <input type="email" value="kronborgnielsen@gmail.com" class="w-full border border-gray-300 rounded email-input" readonly required>
      </div>
    </div>
    <button id="addEmailButton" class="w-full add-button mb-4">Add Another Email</button>

    <div id="discordWebhookContainer" class="mb-4">
        <label class="block text-sm text-gray-600 mb-1">Discord Webhook URL for alerts:</label>
        <div class="input-group webhook-input-group">
            <input type="url" id="webhookInput" value="https://discord.com/api/webhooks/1418654823745716436/vuMKu1s095Cq3BfU06OF_Z_mwxG39zHppHJ3c4BX5X38WuJFWPGhIZdopWTEEXlophiN" placeholder="https://discord.com/api/webhooks/..." class="w-full border border-gray-300 rounded webhook-input" required>
            <button type="button" id="webhookSubmitButton" class="submit-button">Submit</button>
        </div>
    </div>

    <div id="feedback" class="status-feedback"></div>
    <div class="mb-4">
      <label for="frequencySlider" class="block text-sm text-gray-600 mb-1">
        Check every: <span id="frequencyValue" class="font-semibold text-gray-800">10</span> minutes
      </label>
      <input type="range" id="frequencySlider" min="1" max="60" value="10">
    </div>
    <div id="status" class="text-center mb-4">
      <p class="text-lg">Status: <span id="statusText" class="font-semibold">Waiting...</span></p>
      <p class="text-sm text-gray-500">Last checked: <span id="lastChecked">Never</span></p>
      <p class="text-sm text-gray-500">System running for: <span id="runTime">0h 0m 0s</span></p>
      <p class="text-sm text-gray-500">Details: <span id="statusDetails">None</span></p>
    </div>
    <button id="startButton" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Start Checking</button>
    <button id="stopButton" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600 mt-2 hidden">Stop Checking</button>
    <div class="flex mt-2 space-x-2">
        <button id="emailToggleButton" class="w-1/2 py-2 rounded toggle-button active">Deactivate Email Alerts</button>
        <button id="webhookToggleButton" class="w-1/2 py-2 rounded webhook-toggle-button active">Deactivate Discord Alerts</button>
    </div>
    <button id="testEmailButton" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 mt-2">Test Alert(s)</button>
  </div>
  <audio id="beepSound">
    <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          var filteredData = jsonData.filter(row => row.some(filledCell));
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) {
          console.error(e);
          return "";
        }
      }
      return gk_fileData[filename] || "";
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4.4.1/dist/email.min.js"></script>
  <script>
    if (typeof emailjs === 'undefined') {
      console.error('EmailJS failed to load. Please check the CDN URL or network connection.');
      alert('Email functionality is unavailable. Please check your network connection and try again.');
    } else {
      emailjs.init({
        publicKey: "8w7eu6mrg3lRl6ta3"
      });
    }
    const statusText = document.getElementById('statusText');
    const lastChecked = document.getElementById('lastChecked');
    const statusDetails = document.getElementById('statusDetails');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const testEmailButton = document.getElementById('testEmailButton');
    const emailToggleButton = document.getElementById('emailToggleButton');
    const webhookToggleButton = document.getElementById('webhookToggleButton');
    const webhookInput = document.getElementById('webhookInput');
    const webhookSubmitButton = document.getElementById('webhookSubmitButton');
    const beepSound = document.getElementById('beepSound');
    const runTime = document.getElementById('runTime');
    const emailInputsContainer = document.getElementById('emailInputsContainer');
    const discordWebhookContainer = document.getElementById('discordWebhookContainer');
    const addEmailButton = document.getElementById('addEmailButton');
    const feedback = document.getElementById('feedback');
    const frequencySlider = document.getElementById('frequencySlider');
    const frequencyValue = document.getElementById('frequencyValue');
    let intervalId = null;
    let startTime = null;
    let timerInterval = null;
    let currentCheckInterval = 10 * 60 * 1000;
    let emailNotificationsEnabled = true;
    let discordNotificationsEnabled = true;
    
    // Helper function to show temporary feedback
    function showFeedback(message) {
      feedback.textContent = message;
      feedback.classList.add('show');
      setTimeout(() => {
        feedback.classList.remove('show');
      }, 2000);
    }

    // Discord Webhook Logic
    function submitWebhook() {
        const url = webhookInput.value.trim();
        if (!url || !url.startsWith('https://discord.com/api/webhooks/')) {
            alert('Please enter a valid Discord Webhook URL.');
            webhookInput.focus();
            return;
        }
        webhookInput.setAttribute('readonly', 'true');
        webhookSubmitButton.classList.add('hidden');
        
        // Add a remove button
        let removeButton = discordWebhookContainer.querySelector('.remove-button');
        if (!removeButton) {
            removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-button';
            removeButton.textContent = 'Remove';
            discordWebhookContainer.querySelector('.webhook-input-group').appendChild(removeButton);
            removeButton.addEventListener('click', removeWebhook);
        }
        removeButton.classList.remove('hidden');

        showFeedback('Discord Webhook submitted.');
        console.log('Submitted Webhook:', url);
    }

    function removeWebhook() {
        webhookInput.value = '';
        webhookInput.removeAttribute('readonly');
        webhookSubmitButton.classList.remove('hidden');
        const removeButton = discordWebhookContainer.querySelector('.remove-button');
        if (removeButton) {
            removeButton.classList.add('hidden');
        }
        showFeedback('Discord Webhook removed.');
    }

    webhookSubmitButton.addEventListener('click', submitWebhook);
    
    // Auto-submit the default webhook on load
    document.addEventListener('DOMContentLoaded', () => {
        // Only attempt to submit if the default value is present
        if (webhookInput.value.trim()) {
            submitWebhook();
        }
    });

    // Toggle Discord notifications
    webhookToggleButton.addEventListener('click', () => {
      discordNotificationsEnabled = !discordNotificationsEnabled;
      if (discordNotificationsEnabled) {
        webhookToggleButton.textContent = 'Deactivate Discord Alerts';
        webhookToggleButton.classList.remove('inactive', 'bg-gray-500');
        webhookToggleButton.classList.add('active', 'bg-purple-500');
      } else {
        webhookToggleButton.textContent = 'Activate Discord Alerts';
        webhookToggleButton.classList.remove('active', 'bg-purple-500');
        webhookToggleButton.classList.add('inactive', 'bg-gray-500');
      }
      showFeedback(`Discord notifications ${discordNotificationsEnabled ? 'enabled' : 'disabled'}.`);
    });
    
    // Initial state setup for webhook toggle 
    if (discordNotificationsEnabled) {
        webhookToggleButton.classList.add('bg-purple-500');
    }

    // Toggle email notifications
    emailToggleButton.addEventListener('click', () => {
      emailNotificationsEnabled = !emailNotificationsEnabled;
      if (emailNotificationsEnabled) {
        emailToggleButton.textContent = 'Deactivate Email Alerts';
        emailToggleButton.classList.remove('inactive', 'bg-gray-500');
        emailToggleButton.classList.add('active', 'bg-green-500');
      } else {
        emailToggleButton.textContent = 'Activate Email Alerts';
        emailToggleButton.classList.remove('active', 'bg-green-500');
        emailToggleButton.classList.add('inactive', 'bg-gray-500');
      }
      showFeedback(`Email notifications ${emailNotificationsEnabled ? 'enabled' : 'disabled'}.`);
    });
    
    // Initial state setup for email toggle 
    if (emailNotificationsEnabled) {
        emailToggleButton.classList.add('bg-green-500');
    }

    // Helper function to calculate a random interval
    function getRandomInterval(baseInterval) {
      const variation = Math.floor(Math.random() * (120000 - 60000 + 1)) + 60000; // Random between 1 and 2 minutes
      const randomSign = Math.random() < 0.5 ? -1 : 1; 
      return baseInterval + (randomSign * variation);
    }
    // Update the displayed value as the slider is moved
    frequencySlider.addEventListener('input', function() {
      frequencyValue.textContent = this.value;
      if (intervalId) {
        stopChecking();
        startChecking();
      }
    });

    // Dynamic Email Input Management
    function addEmailInputField() {
      const emailInputGroup = document.createElement('div');
      emailInputGroup.className = 'input-group';
      emailInputGroup.innerHTML = `
        <input type="email" placeholder="anothername@example.com" class="w-full border border-gray-300 rounded email-input">
        <button type="button" class="submit-button">Submit</button>
      `;
      emailInputsContainer.appendChild(emailInputGroup);
      const submitButton = emailInputGroup.querySelector('.submit-button');
      const emailInput = emailInputGroup.querySelector('.email-input');
      submitButton.addEventListener('click', function() {
        const email = emailInput.value.trim();
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          alert('Please enter a valid email address.');
          emailInput.focus();
          return;
        }
        emailInput.setAttribute('readonly', 'true');
        submitButton.remove();
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'remove-button';
        removeButton.textContent = 'Remove';
        emailInputGroup.appendChild(removeButton);
        removeButton.addEventListener('click', function() {
          emailInputGroup.remove();
          showFeedback('Email removed.');
        });
        showFeedback('Email submitted.');
        console.log('Submitted email:', email);
      });
      console.log('Added new email input field');
      showFeedback('Email field added.');
    }
    document.addEventListener('DOMContentLoaded', () => {
      const initialInputGroup = emailInputsContainer.querySelector('.input-group');
      const initialInput = initialInputGroup.querySelector('.email-input');
      initialInput.required = true;
    });
    addEmailButton.addEventListener('click', addEmailInputField);
    function formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours}h ${minutes}m ${secs}s`;
    }
    function updateRunTime() {
      if (startTime) {
        const now = Date.now();
        runTime.textContent = formatDuration(now - startTime);
      }
    }
    function startTimer() {
      if (!startTime) {
        startTime = Date.now();
        timerInterval = setInterval(updateRunTime, 2000);
      }
    }
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      startTime = null;
      runTime.textContent = '0h 0m 0s';
    }
    function playThreeBeeps() {
      let beepCount = 0;
      const beepInterval = setInterval(() => {
        if (beepCount < 3) {
          beepSound.currentTime = 0;
          beepSound.play().catch(() => console.log('Audio playback failed'));
          beepCount++;
        } else {
          clearInterval(beepInterval);
          beepSound.pause();
          beepSound.currentTime = 0;
        }
      }, 1500);
    }

    async function sendDiscordWebhook(status, details) {
        if (!discordNotificationsEnabled) {
            console.log('Discord webhook notifications are disabled; skipping.');
            return;
        }

        const webhookUrl = webhookInput.value.trim();
        if (!webhookUrl || !webhookInput.hasAttribute('readonly')) {
            console.warn('No valid or submitted Discord Webhook URL found. Skipping webhook alert.');
            return;
        }

        let color = 16711680; // Red for errors/not accessible (0xFF0000)
        let iconUrl = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';
        if (status.includes('accessible') || status.includes('queue')) {
            color = 65280; // Green for accessible (0x00FF00)
        } else if (status.includes('Test')) {
            color = 16776960; // Yellow for test (0xFFFF00)
        }

        const payload = {
            content: status === 'Shop is accessible!' ? '@everyone The Pokémon Center Shop is OPEN!' : status.includes('queue') ? '@everyone Pokémon Center Queue Detected!' : null,
            embeds: [{
                title: status,
                description: details,
                color: color,
                timestamp: new Date().toISOString(),
                footer: {
                    text: 'Pokémon Center Shop Access Checker',
                    icon_url: iconUrl
                },
                fields: [{
                    name: 'Status Time',
                    value: new Date().toLocaleTimeString(),
                    inline: true
                }]
            }]
        };

        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (response.ok) {
                console.log('Discord Webhook sent successfully.');
            } else {
                const responseBody = await response.text();
                console.error('Failed to send Discord Webhook:', response.status, responseBody);
            }
        } catch (error) {
            console.error('Error sending Discord Webhook:', error);
        }
    }

    function sendEmail(status, details, recipientEmails) {
      if (!emailNotificationsEnabled) {
        console.log('Email notifications are disabled; skipping email sending.');
        return;
      }
      if (!recipientEmails || recipientEmails.length === 0) {
        console.error('No email addresses provided for sending alerts');
        return;
      }
      if (typeof emailjs === 'undefined') {
        console.error('EmailJS is not available');
        return;
      }
      recipientEmails.forEach(email => {
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          console.warn(`Invalid email address: ${email}. Skipping.`);
          return;
        }
        emailjs.send("service_ahqdaj5", "template_whhvnra", {
          status: status,
          details: details,
          timestamp: new Date().toLocaleString(),
          to_email: email
        }).then(
          () => console.log('Email sent successfully to', email),
          (error) => console.error('Failed to send email to', email, ':', error)
        );
      });
    }
    function testEmail() {
      const emailInputs = document.querySelectorAll('.email-input');
      const recipientEmails = ['kronborgnielsen@gmail.com'];
      let hasValidEmail = true;
      Array.from(emailInputs).slice(1).forEach((input, index) => {
        const email = input.value.trim();
        if (email && input.hasAttribute('readonly')) {
          if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            recipientEmails.push(email);
          } else {
            alert(`Please ensure email ${index + 1} is valid: ${email}`);
            input.focus();
            hasValidEmail = false;
          }
        }
      });
      if (!hasValidEmail) {
        return;
      }
      if (recipientEmails.length === 0 && !discordNotificationsEnabled) {
        console.warn('No valid alert methods provided.');
        alert('No valid email or Discord alerts provided/enabled.');
        return;
      }
      if (emailNotificationsEnabled && typeof emailjs === 'undefined') {
        alert('Email functionality is unavailable. Please check your network connection and try again.');
        return;
      }
      
      const testStatus = 'Test Alert: Everything is OK';
      const testDetails = 'This is a test notification from the Pokémon Center Shop Access Checker.';

      if (emailNotificationsEnabled && recipientEmails.length > 0) {
        console.log('Sending test email to:', recipientEmails);
        sendEmail(testStatus, testDetails, recipientEmails);
      } else {
          console.warn('Skipping test email: No valid emails or emails disabled.');
      }

      if (discordNotificationsEnabled && webhookInput.hasAttribute('readonly')) {
          console.log('Sending test Discord webhook.');
          sendDiscordWebhook(testStatus, testDetails);
      } else {
          console.warn('Skipping test Discord webhook: No valid webhook or webhooks disabled.');
      }

      alert('Test alert(s) sent! Check your inbox(es)/Discord channel(s).');
    }
    function extractQueueLength(text) {
      const patterns = [
        /(\d+)\s*users?\s*ahead/i,
        /queue\s*position\s*[:=]?\s*(\d+)/i,
        /(\d+)\s*in\s*queue/i,
        /position\s*in\s*queue\s*[:=]?\s*(\d+)/i
      ];
      for (const pattern of patterns) {
        const match = text.match(pattern);
        if (match) return match[1];
      }
      return null;
    }
    async function checkShopAccess() {
      const emailInputs = document.querySelectorAll('.email-input');
      const currentEmails = ['kronborgnielsen@gmail.com'];
      Array.from(emailInputs)
        .slice(1)
        .filter(input => input.hasAttribute('readonly'))
        .map(input => input.value.trim())
        .filter(email => email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))
        .forEach(email => currentEmails.push(email));
      console.log('Emails for notifications:', currentEmails);
      if (currentEmails.length === 0 && !discordNotificationsEnabled) {
        console.warn('No valid alert methods active. Skipping alerts for this check.');
      }
      try {
        const proxies = [
          'https://corsproxy.io/?',
          'https://cors-anywhere.herokuapp.com/',
          'https://allorigins.win/raw?url='
        ];
        const targetUrls = [
          'https://www.pokemoncenter.com/',
          'https://www.pokemoncenter.com/category/trading-card-game'
        ];
        let response = null;
        let proxyUsed = '';
        let urlUsed = '';
        let proxyErrors = [];
        for (const targetUrl of targetUrls) {
          for (const proxy of proxies) {
            try {
              response = await fetch(proxy + encodeURIComponent(targetUrl), {
                method: 'GET',
                headers: {
                  'Accept': 'text/html',
                },
              });
              proxyUsed = proxy;
              urlUsed = targetUrl;
              if (response.ok && response.status === 200) break;
              proxyErrors.push(`Proxy ${proxy} for ${targetUrl} returned status: ${response?.status || 'unknown'}`);
            } catch (proxyError) {
              proxyErrors.push(`Proxy ${proxy} for ${targetUrl} failed: ${proxyError.message}`);
              console.warn(`Proxy ${proxy} for ${targetUrl} failed:`, proxyError);
            }
            if (response && response.ok && response.status === 200) break;
          }
          if (response && response.ok && response.status === 200) break;
        }
        const now = new Date().toLocaleTimeString();
        lastChecked.textContent = now;
        if (!response || !response.ok) {
          const status = 'Proxy error';
          const details = `Failed to fetch page through all proxies. Errors: ${proxyErrors.join('; ')}. Please check the site manually.`;
          statusText.textContent = status;
          statusText.classList.remove('text-green-500');
          statusText.classList.add('text-red-500');
          statusDetails.textContent = details;
          playThreeBeeps();
          sendEmail(status, details, currentEmails);
          sendDiscordWebhook(status, details);
          statusText.dataset.previousStatus = status;
          return;
        }
        const finalUrl = decodeURIComponent(response.url.replace(proxyUsed, ''));
        const text = await response.text();
        const isQueue =
          /queue-it\.net/i.test(finalUrl) ||
          /waiting room|queue-it|waitingroom|virtual waiting/i.test(text);
        if (isQueue) {
          const queueLength = extractQueueLength(text);
          const currentStatus = 'Shop is active (in queue)';
          statusText.textContent = currentStatus;
          statusText.classList.remove('text-red-500');
          statusText.classList.add('text-green-500');
          const details = `Queue detected at ${finalUrl} (checked ${urlUsed}). Queue length: ${queueLength || 'unknown'}. Redirecting to Pokémon Center homepage.`;
          statusDetails.textContent = details;
          playThreeBeeps();
          if (statusText.dataset.previousStatus !== currentStatus) {
              sendEmail(currentStatus, details, currentEmails);
              sendDiscordWebhook(currentStatus, details);
          }
          statusText.dataset.previousStatus = currentStatus;
          stopChecking();
          window.location.href = 'https://www.pokemoncenter.com/';
          return;
        } else if (/pokemoncenter\.com(\/|$|\/category\/trading-card-game)/i.test(finalUrl)) {
          const hasShopContent = /shop|products|category|store|cart|new releases|all products|add to cart|merchandise|collectibles|plush|trading card|Pokémon/i.test(text);
          const hasDynamicElements = /<nav\b|<a\b[^>]*href=["'][^"']*product[^"']*["']|<div\b[^>]*class=["'][^"']*product[^"']*["']/i.test(text);
          const isLargeResponse = text.length > 10000;
          if (hasShopContent || hasDynamicElements || isLargeResponse) {
            const currentStatus = 'Shop is accessible!';
            statusText.textContent = currentStatus;
            statusText.classList.remove('text-red-500');
            statusText.classList.add('text-green-500');
            const details = `Reached ${finalUrl} (checked ${urlUsed}), shop content detected (keywords or dynamic elements present). Response length: ${text.length} chars.`;
            statusDetails.textContent = details;
            if (statusText.dataset.previousStatus !== currentStatus) {
                sendEmail(currentStatus, statusDetails.textContent, currentEmails);
                sendDiscordWebhook(currentStatus, statusDetails.textContent);
            }
            statusText.dataset.previousStatus = currentStatus;
          } else {
            const currentStatus = 'Shop is not accessible (landing page)';
            statusText.textContent = currentStatus;
            statusText.classList.remove('text-green-500');
            statusText.classList.add('text-red-500');
            const details = `Reached ${finalUrl} (checked ${urlUsed}), but no shop content or dynamic elements found. Likely a static landing page. Response length: ${text.length} chars.`;
            statusDetails.textContent = details;
            playThreeBeeps();
            if (statusText.dataset.previousStatus !== currentStatus) {
                sendEmail(currentStatus, details, currentEmails);
                sendDiscordWebhook(currentStatus, details);
            }
            statusText.dataset.previousStatus = currentStatus;
          }
        } else {
          const currentStatus = 'Shop is not accessible (unexpected page)';
          statusText.textContent = currentStatus;
          statusText.classList.remove('text-green-500');
          statusText.classList.add('text-red-500');
          const details = `Reached ${finalUrl} (checked ${urlUsed}), but it does not appear to be the Pokémon Center shop. Response length: ${text.length} chars.`;
          statusDetails.textContent = details;
          playThreeBeeps();
          if (statusText.dataset.previousStatus !== currentStatus) {
              sendEmail(currentStatus, details, currentEmails);
              sendDiscordWebhook(currentStatus, details);
          }
          statusText.dataset.previousStatus = currentStatus;
        }
      } catch (error) {
        console.error('Error checking page:', error);
        const status = 'Site is down';
        const details = `Failed to fetch: ${error.message}. Please check the site manually.`;
        statusText.textContent = status;
        statusText.classList.remove('text-green-500');
        statusText.classList.add('text-red-500');
        statusDetails.textContent = details;
        lastChecked.textContent = new Date().toLocaleTimeString();
        playThreeBeeps();
        if (statusText.dataset.previousStatus !== status) {
            sendEmail(status, details, currentEmails);
            sendDiscordWebhook(status, details);
        }
        statusText.dataset.previousStatus = status;
      }
    }
    function startChecking() {
      const emailInputs = document.querySelectorAll('.email-input');
      const webhookUrl = webhookInput.value.trim();
      let allAlertsConfigured = true;

      Array.from(emailInputs).forEach((input) => {
        const email = input.value.trim();
        if (email && !input.hasAttribute('readonly')) {
          alert('Please submit all additional email addresses before starting.');
          input.focus();
          allAlertsConfigured = false;
        } else if (email && input.hasAttribute('readonly')) {
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            alert(`Please ensure email is valid: ${email}`);
            input.focus();
            allAlertsConfigured = false;
          }
        }
      });

      if (webhookUrl && !webhookInput.hasAttribute('readonly')) {
        alert('Please submit the Discord Webhook URL before starting.');
        webhookInput.focus();
        allAlertsConfigured = false;
      }
      
      if (!allAlertsConfigured) {
        return;
      }
      const currentEmails = ['kronborgnielsen@gmail.com'];
      Array.from(emailInputs)
        .slice(1)
        .filter(input => input.hasAttribute('readonly'))
        .map(input => input.value.trim())
        .filter(email => email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))
        .forEach(email => currentEmails.push(email));
      if (currentEmails.length === 0 && !webhookInput.hasAttribute('readonly')) {
        console.warn('No valid email or Discord webhook configured.');
        alert('Please configure at least one valid email or a Discord webhook before starting.');
        return;
      }
      if (intervalId) {
        clearTimeout(intervalId);
      }
      function scheduleNextCheck() {
        currentCheckInterval = parseInt(frequencySlider.value) * 60 * 1000;
        const randomizedInterval = getRandomInterval(currentCheckInterval);
        console.log(`Next check in ${randomizedInterval / 1000 / 60} minutes`);
        intervalId = setTimeout(() => {
          checkShopAccess();
          scheduleNextCheck();
        }, randomizedInterval);
      }
      checkShopAccess();
      scheduleNextCheck();
      startButton.classList.add('hidden');
      stopButton.classList.remove('hidden');
      statusText.textContent = 'Checking...';
      statusDetails.textContent = 'Started checking with randomized intervals.';
      startTimer();
    }
    function stopChecking() {
      if (intervalId) {
        clearTimeout(intervalId);
        intervalId = null;
        startButton.classList.remove('hidden');
        stopButton.classList.add('hidden');
        statusText.textContent = 'Stopped.';
        statusDetails.textContent = 'Checking stopped.';
        stopTimer();
      }
    }
    startButton.addEventListener('click', startChecking);
    stopButton.addEventListener('click', stopChecking);
    testEmailButton.addEventListener('click', testEmail);
  </script>
</body>
</html>
