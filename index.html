<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PokeDrop Master - Ultimate Pok√©mon Center Drop Hunter</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Wild Pok√©mon Theme: Sky gradients, floating elements, evolutions */
    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 25%, #90EE90 50%, #ADD8E6 75%, #FFB6C1 100%);
      background-size: 400% 400%;
      animation: skyShift 20s ease infinite;
      position: relative;
      overflow-x: hidden;
      min-height: 100vh;
    }
    @keyframes skyShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .poke-sky { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .floating-poke { position: absolute; opacity: 0.7; animation: float 6s ease-in-out infinite; }
    .pikachu { top: 10%; left: 5%; width: 80px; animation-delay: 0s; }
    .umbreon { top: 20%; right: 5%; width: 100px; animation-delay: 2s; }
    .snorlax { bottom: 10%; left: 10%; width: 120px; animation: snore 4s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }
    @keyframes snore { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .pokeball-float { position: absolute; width: 30px; height: 30px; background: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png') no-repeat; background-size: contain; opacity: 0.5; animation: spin 3s linear infinite; z-index: 1; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .main-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 25px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 2rem auto;
      position: relative;
      z-index: 10;
      border: 2px solid #FF6B6B;
      animation: evolveIn 1s ease-out;
    }
    @keyframes evolveIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .status-pokedex { background: linear-gradient(145deg, #FF9A56, #FF6B6B); color: white; padding: 1rem; border-radius: 15px; margin: 1rem 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
    button { background: linear-gradient(145deg, #4ECDC4, #44A08D); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 50px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin: 0.5rem 0; }
    button:hover:not(:disabled) { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    button:disabled { background: #CCC; transform: none; box-shadow: none; cursor: not-allowed; }
    input, select { border: 2px solid #4ECDC4; border-radius: 10px; padding: 0.5rem; width: calc(100% - 1rem); margin: 0.5rem 0; }
    input:disabled, button:disabled { opacity: 0.6; }
    input[type="range"]::-webkit-slider-thumb { background: #FF6B6B; border-radius: 50%; }
    .alert-zap { animation: zap 0.5s ease; }
    @keyframes zap { 0%, 100% { border-color: #FFD700; box-shadow: 0 0 20px #FFD700; } 50% { border-color: #FF6B6B; box-shadow: 0 0 30px #FF6B6B; } }
    .hidden { display: none; }
    fieldset { border: none; padding: 0; margin: 0; }
    fieldset:disabled { opacity: 0.5; }
    /* Responsive */
    @media (max-width: 480px) { .main-card { margin: 1rem; padding: 1rem; } .floating-poke { width: 50px; } }
  </style>
</head>
<body>
  <div class="poke-sky">
    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png" class="floating-poke pikachu" alt="Pikachu">
    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/197.png" class="floating-poke umbreon" alt="Umbreon">
    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/143.png" class="floating-poke snorlax" alt="Snorlax">
    <div class="pokeball-float" style="top: 30%; left: 80%;"></div>
    <div class="pokeball-float" style="top: 60%; right: 20%; animation-delay: 1s;"></div>
  </div>

  <div class="main-card">
    <h1 style="text-align: center; color: #FF6B6B; font-size: 1.8rem; margin-bottom: 1rem;">üåÄ PokeDrop Master</h1>
    <p style="text-align: center; color: #666; margin-bottom: 1rem;">Hunt drops like a pro trainer! Monitors new releases, queues, & auto-joins lines.</p>

    <button id="signInBtn" onclick="signInAnonymously()" style="background: #4CAF50; width: 100%;">Sign In Anonymously to Start</button>
    <div id="emailSection" class="hidden">
      <label>Your Email for Alerts:</label>
      <input type="email" id="emailInput" placeholder="user@example.com">
      <button onclick="subscribeEmail(document.getElementById('emailInput').value)">Subscribe</button>
      <button onclick="testEmail()">Test Email</button>
    </div>

    <fieldset id="mainControls" disabled>
      <label>Discord Webhook URL (for alerts):</label>
      <input type="url" id="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
      <button onclick="testDiscord()">Test Discord Ping</button>

      <label>Check every: <span id="freqVal">5</span> mins</label>
      <input type="range" id="freqSlider" min="1" max="30" value="5">
      <label>Alert after: <span id="threshVal">2</span> fails</label>
      <input type="range" id="threshSlider" min="1" max="5" value="2">
      <label>Specific Product URL (optional):</label>
      <input type="url" id="specificUrl" placeholder="https://www.pokemoncenter.com/product/...">
    </fieldset>

    <div id="status" class="status-pokedex">
      <p><strong>Status:</strong> <span id="statusText">Ready to evolve!</span></p>
      <p>Last Check: <span id="lastCheck">Never</span></p>
      <p>Runtime: <span id="runtime">0m 0s</span></p>
      <p>Consec Fails: <span id="consec">0</span></p>
      <p>New Products: <span id="newCount">0</span></p>
      <p>Details: <span id="details">Sign in to begin...</span></p>
    </div>

    <button id="startBtn" onclick="startMonitoring()" disabled>üöÄ Start Hunt</button>
    <button id="stopBtn" class="hidden" onclick="stopMonitoring()">‚èπÔ∏è Stop Hunt</button>
  </div>

  <audio id="pikacry" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, query } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

    // IMPORTANT: Replace with your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCAXDkAaED4PqSW3lgpXwPMbOHnoq-5ybo", // This is safe to expose
      authDomain: "pokemoncentermail.firebaseapp.com",
      projectId: "pokemoncentermail",
      storageBucket: "pokemoncentermail.firebasestorage.app",
      messagingSenderId: "823572131347",
      appId: "1:823572131347:web:13db2feafe741d5e5459e6",
      measurementId: "G-M55TXWL2YQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global var for app
    let currentUser = null;

    // Sign-in function
    window.signInAnonymously = async () => {
      try {
        const result = await signInAnonymously(auth);
        console.log('Signed in as:', result.user.uid);
        alert('Signed in! You can now start the hunt.');
      } catch (error) {
        console.error('Sign-in error:', error);
        alert(`Sign-in failed: ${error.message}`);
      }
    };

    // Listen for auth changes to update UI
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      const mainControls = document.getElementById('mainControls');
      const startBtn = document.getElementById('startBtn');

      if (user) {
        // User is signed in
        document.getElementById('signInBtn').classList.add('hidden');
        document.getElementById('emailSection').classList.remove('hidden');
        mainControls.disabled = false;
        startBtn.disabled = false;
        document.getElementById('details').textContent = 'Ready for your command...';
        loadSubscription();
      } else {
        // User is signed out
        document.getElementById('signInBtn').classList.remove('hidden');
        document.getElementById('emailSection').classList.add('hidden');
        mainControls.disabled = true;
        startBtn.disabled = true;
      }
    });

    // Add/update email subscription
    window.subscribeEmail = async (email) => {
      if (!currentUser) return alert('Sign in first!');
      if (!email || !/\S+@\S+\.\S+/.test(email)) return alert('Enter a valid email!');
      try {
        await setDoc(doc(db, 'subscribers', currentUser.uid), {
          email: email,
          subscribed: true,
          timestamp: new Date()
        });
        alert('Subscribed! You will now receive email alerts.');
      } catch (error) {
        console.error('Subscription error:', error);
      }
    };
    
    // Load user's subscription
    async function loadSubscription() {
      if (!currentUser) return;
      try {
        const docSnap = await getDoc(doc(db, 'subscribers', currentUser.uid));
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('emailInput').value = data.email;
        }
      } catch (error) {
        console.error('Load error:', error);
      }
    }

    // --- EMAIL SENDING LOGIC (BACKEND REQUIRED) ---
    async function triggerEmail(type, data = {}) {
        if (!currentUser) return alert("Please sign in first.");
        
        // ‚¨áÔ∏è *** PASTE YOUR DEPLOYED FUNCTION URL HERE *** ‚¨áÔ∏è
        const functionUrl = 'YOUR_CLOUD_FUNCTION_URL_HERE';

        if (functionUrl === 'YOUR_CLOUD_FUNCTION_URL_HERE') {
            return alert("Backend not configured. Please deploy the Cloud Function and add its URL to the script.");
        }
        
        try {
            console.log(`Calling cloud function for '${type}' email...`);
            const response = await fetch(functionUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type, data, userId: currentUser.uid })
            });
            if (response.ok) {
                console.log("Email sent successfully!");
                alert(`'${type}' email sent successfully! Check your inbox.`);
            } else {
                const errorText = await response.text();
                console.error("Failed to send email:", errorText);
                alert(`Failed to send email: ${errorText}`);
            }
        } catch (error) {
            console.error("Error calling cloud function:", error);
            alert("An error occurred while trying to send the email.");
        }
    }

    window.testEmail = () => triggerEmail('test');
    window.sendDropAlertEmail = (message) => triggerEmail('alert', { message });

  </script>

  <script>
    // State Vars
    let intervalId = null, startTime = null, consecFails = 0, failThresh = 2, checkFreq = 5 * 60 * 1000;
    let lastProducts = JSON.parse(localStorage.getItem('last_products') || '[]');
    let proxies = ['https://corsproxy.io/?', 'https://api.allorigins.win/get?url='];
    let blacklisted = new Set();
    let isHunting = false;

    // UI Helpers
    function updateUI(status, details = '', newProds = 0) {
      const statusTextEl = document.getElementById('statusText');
      statusTextEl.textContent = status;
      document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString();
      document.getElementById('consec').textContent = consecFails;
      document.getElementById('newCount').textContent = newProds;
      document.getElementById('details').textContent = details;
      
      const statusBox = document.getElementById('status');
      statusBox.classList.remove('alert-zap');
      if (newProds > 0 || /drop|new|queue/i.test(status)) {
        setTimeout(() => statusBox.classList.add('alert-zap'), 10);
      }
      updateRuntime();
    }
    function updateRuntime() {
      if (startTime) {
        const elapsed = Date.now() - startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('runtime').textContent = `${minutes}m ${seconds}s`;
      }
    }
    setInterval(updateRuntime, 1000);

    // Discord Test/Send
    async function sendDiscord(title, desc, color = 0xFFD700) {
      const webhookUrl = document.getElementById('discordWebhook').value;
      if (!webhookUrl) return;
      const embed = { title, description: desc, color, footer: { text: `PokeDrop Master | ${new Date().toLocaleString()}` } };
      try {
        await fetch(webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ embeds: [embed] }) });
      } catch (e) { console.error('Discord fail:', e); }
    }
    async function testDiscord() {
      if (!document.getElementById('discordWebhook').value) return alert('Please enter a Discord Webhook URL first.');
      await sendDiscord('üß™ Test Ping', 'Your webhook is live! Ready for drops. ‚ö°');
      alert('Test sent! Check your Discord.');
    }

    // Play Pok√© Cry
    function playCry() {
      const audio = document.getElementById('pikacry');
      audio.src = 'https://raw.githubusercontent.com/PokeAPI/audio/master/cries/2021/25.mp3';
      audio.play().catch(e => console.error("Audio play failed. User interaction may be required first.", e));
    }

    // Proxy Test/Rotate
    async function getHealthyProxy(url) {
      for (let p of proxies.filter(pr => !blacklisted.has(pr))) {
        try {
          const ctrl = new AbortController();
          setTimeout(() => ctrl.abort(), 8000);
          const res = await fetch(`${p}${encodeURIComponent(url)}`, { signal: ctrl.signal, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (res.ok) return p;
        } catch {}
        blacklisted.add(p);
        setTimeout(() => blacklisted.delete(p), 300000);
      }
      return null;
    }

    // Data Extraction
    function extractQueue(text, url) {
      const posMatch = text.match(/pos["']?\s*[:=]\s*["']?(\d+)["']?/i) || url.match(/pos=(\d+)/i);
      return posMatch ? posMatch[1] : null;
    }

    function extractProducts(text) {
      const productMatches = [...text.matchAll(/<a[^>]*href=["']([^"']*product[^"']*)["'][^>]*>([^<]+)<\/a>/gi)];
      return productMatches.map(m => ({ url: m[1], title: m[2].trim() })).slice(0, 20);
    }
    
    function detectNewProducts(currentProds) {
        if (lastProducts.length === 0 && currentProds.length > 0) {
            lastProducts = currentProds;
            localStorage.setItem('last_products', JSON.stringify(lastProducts));
            return { count: 0, new: [] };
        }
        const newOnes = currentProds.filter(p => !lastProducts.some(lp => lp.title === p.title));
        if (newOnes.length > 0) {
            lastProducts = currentProds;
            localStorage.setItem('last_products', JSON.stringify(lastProducts));
        }
        return { count: newOnes.length, new: newOnes };
    }


    // Main Check Function
    async function checkSite(isConsec = false) {
      const specific = document.getElementById('specificUrl').value || '';
      const urls = specific ? [specific] : ['https://www.pokemoncenter.com/category/new-releases', 'https://www.pokemoncenter.com/'];
      let details = 'Checking URLs...';
      let status = 'Hunting... üïµÔ∏è';
      let newProductsResult = { count: 0, new: [] };
      let foundSomething = false;

      for (let url of urls) {
        if (foundSomething) break;
        const proxy = await getHealthyProxy(url);
        if (!proxy) {
          details = 'All CORS proxies seem to be down. Cannot check site.';
          continue;
        }
        try {
          const res = await fetch(`${proxy}${encodeURIComponent(url)}`);
          if (res.ok) {
            const text = proxy.includes('allorigins') ? (await res.json()).contents : await res.text();
            
            if (/queue-it\.net/i.test(res.url) || /waiting room/i.test(text)) {
              const queuePos = extractQueue(text, res.url);
              status = `Queue Detected! üö¶`;
              details = `Position: ${queuePos || 'Unknown'}. Attempting to join...`;
              if (!isConsec) window.location.href = 'https://www.pokemoncenter.com/';
              foundSomething = true;
            } else if (text.length > 2000) {
                const currentProducts = extractProducts(text);
                newProductsResult = detectNewProducts(currentProducts);
                if (newProductsResult.count > 0) {
                    status = 'DROP DETECTED! üèÜ';
                    details = `${newProductsResult.count} new product(s): ${newProductsResult.new.map(np => np.title).join(', ')}`;
                    playCry();
                } else {
                    status = 'All clear, nothing to hunt';
                    details = 'No new products found on this check.';
                }
                foundSomething = true;
            }
          }
        } catch (e) { console.error(e); }
      }

      if (!foundSomething) {
        consecFails++;
        status = 'Check Failed üö´';
        details = 'Could not access the site. Might be down or blocked.';
      } else {
        consecFails = 0;
      }
      
      updateUI(status, details, newProductsResult.count);

      if (status.includes('DROP') || status.includes('Queue')) {
        sendDiscord('üö® PokeDrop Alert!', details);
        window.sendDropAlertEmail(details);
      }
    }

    // Start/Stop
    async function startMonitoring() {
      isHunting = true;
      consecFails = 0;
      startTime = Date.now();
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('stopBtn').classList.remove('hidden');
      document.getElementById('mainControls').disabled = true;

      await checkSite();
      intervalId = setInterval(checkSite, checkFreq + Math.random() * 20000 - 10000);
      updateUI('Hunting... üïµÔ∏è');
    }

    function stopMonitoring() {
      clearInterval(intervalId);
      intervalId = null;
      startTime = null;
      isHunting = false;
      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('stopBtn').classList.add('hidden');
      document.getElementById('mainControls').disabled = false;
      updateUI('Hunt Paused üõë', 'Monitoring has been stopped.');
    }

    // Sliders & Load Saved State
    document.addEventListener('DOMContentLoaded', () => {
        const freqSlider = document.getElementById('freqSlider');
        const threshSlider = document.getElementById('threshSlider');
        freqSlider.value = localStorage.getItem('freq') || 5;
        threshSlider.value = localStorage.getItem('thresh') || 2;
        
        document.getElementById('freqVal').textContent = freqSlider.value;
        document.getElementById('threshVal').textContent = threshSlider.value;
        
        checkFreq = freqSlider.value * 60 * 1000;
        failThresh = threshSlider.value;

        freqSlider.oninput = e => { 
            checkFreq = e.target.value * 60 * 1000; 
            document.getElementById('freqVal').textContent = e.target.value; 
            localStorage.setItem('freq', e.target.value); 
        };
        threshSlider.oninput = e => { 
            failThresh = e.target.value; 
            document.getElementById('threshVal').textContent = e.target.value; 
            localStorage.setItem('thresh', e.target.value); 
        };
    });
  </script>
</body>
</html>
